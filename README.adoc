== The Github Repository Tracker

First things first: thank you for buying our book!
We're excited to have you on board.

This guide will help you set up the necessary tools to deploy the code from the repository included in the CloudWatch Book into your own AWS account.

[title="The Github Repository Tracker", reftext={chapter}.{counter:figure}]
image::docs/images/architecture.png[width=600, align="center"]

We'll provide instructions for macOS, Linux, and Windows. If you're using a different operating system, you can follow the instructions for Linux, as they are the most similar to other Unix-based systems.

=== Installing the Necessary Tools

You need to have the following tools installed:

- link:https://github.com/nvm-sh/nvm[NVM]: Node Version Manager is used to easily install and manage multiple versions of Node.js and npm. Alternatively, you can directly install link:https://nodejs.org/[Node.js] and link:https://www.npmjs.com/[npm] if you prefer.
- link:https://pnpm.io/[pnpm]: A fast, disk space-efficient package manager. It is recommended to use pnpm instead of npm or yarn. This is not strictly necessary though.
- link:https://aws.amazon.com/cli/[AWS CLI]: The AWS Command Line Interface is used to interact with AWS services from the command line. It's also used by our deployment scripts.

Depending on the track(s) you want to follow, you also need to install the link:https://aws.amazon.com/cdk/[Cloud Development Kit] and/or link:https://www.terraform.io/[Terraform], but more on that in the dedicated chapters.

==== macOS

With macOS, the installation process is quite straightforward:

* Install link:https://brew.sh/[Homebrew] if you don't have it.

[source,sh]
----
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
----

* Install link:https://formulae.brew.sh/formula/nvm[NVM] via homebrew.

[source,sh]
----
brew install nvm
----

Please make sure that the binary is exported in your shell configuration file (e.g., `~/.bashrc`, `~/.zshrc`, or `~/.profile`). NVM will provide you with the necessary instructions after installation.

* Install Node.js and npm using NVM:

[source,sh]
----
nvm install node # "node" is an alias for the latest version
# you can also install a specific version
----

* Install pnpm:

[source,sh]
----
npm install -g pnpm
----

* Install AWS CLI:

[source,sh]
----
brew install awscli
----

==== Linux

On Linux, the installation process is similar to macOS:

* Install NVM:

[source,sh]
----
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
----

As with macOS, please make sure that the binary is exported in your shell configuration file (e.g., `~/.bashrc`, `~/.zshrc`, or `~/.profile`). NVM will provide you with the necessary instructions after installation.

* Install Node.js and npm using NVM:

[source,sh]
----
nvm install node # "node" is an alias for the latest version
# you can also install a specific version
----

* Install pnpm:

[source,sh]
----
npm install -g pnpm
----

* Install AWS CLI:

[source,sh]
----
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
----


==== Windows

If you're working with Windows, you need to use link:https://learn.microsoft.com/en-gb/windows/wsl/install[WSL] (Windows Subsystem for Linux).

With this, you can run a Linux distribution on your Windows machine, which basically allow you to follow the Linux instructions.

After you've successfully installed WSL, you can enter the Linux shell by running `wsl` in your command prompt.

****
*Important*: You'll also need to transpile our bash scripts via `dos2unix` or a similar tool, as the line endings are different on Windows. You can install `dos2unix` via `sudo apt install dos2unix` on your WSL.
Afterwards, you should transpile all files inside the `scripts` directory by running `dos2unix scripts/*`.
****

=== Next Steps

Once you have all the tools installed, you can proceed to deploy the code from the repository. Follow the instructions in the next document to set up your AWS environment and deploy the code.

== Using the Terraform Track

Terraform is a tool for building, changing, and versioning infrastructure safely and efficiently. Terraform can manage existing and popular service providers as well as custom in-house solutions.

It's one of two infrastructure tracks we provide with the CloudWatch book.

=== Installing Terraform

To get started with Terraform, you need to install the binary on your local machine. We recommend to use the `tfenv` tool to manage different versions of Terraform.

==== macOS

With macOS, the installation process is quite straightforward:

* Install link:https://formulae.brew.sh/formula/tfenv[tfen] via Homebrew:

[source,sh]
----
brew install tfenv
----

* If it wasn't done automatically, don't forget to extend your PATH variable to include the `tfenv` binary:

[source,sh]
----
# bash
echo 'export PATH="$HOME/.tfenv/bin:$PATH"' >> ~/.bash_profile
# zsh
echo 'export PATH="$HOME/.tfenv/bin:$PATH"' >> ~/.zprofile
----

That's already it.
As the `infra/terraform` folder contains a `.terraform_version` file, `tfenv` will take care of the correct version for you.

==== Linux

The process on Linux is quite similar to macOS.
Please use the instructions in the link:https://github.com/tfutils/tfenv[tfenv GitHub repository] to install the tool.

For example:

* via Arch User Repository

[source,sh]
----
yay --sync tfenv
----

* or via the GitHub repository

[source,sh]
----
git clone git clone --depth=1 https://github.com/tfutils/tfenv.git ~/.tfenv
# please export the binary path to your PATH
# bash
echo 'export PATH=$PATH:$HOME/.tfenv/bin' >> ~/.bashrc
# zsh
echo 'export PATH=$PATH:$HOME/.tfenv/bin' >> ~/.zshrc
----

==== Windows

On Windows with WSL, you can follow the Linux instructions.
You only need another export command for your PATH:

[source,sh]
----
echo 'export PATH=$PATH:$HOME/.tfenv/bin' >> ~/.bashrc
----


=== Applying our Infrastructure

We've bundled everything into a single deploy script to make it easier for you to get started.

But let's have a look at the folder structure first:

[source,plaintext]
----
root/
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ lambda/
â”œâ”€â”€ infra/
â”‚   â””â”€â”€ terraform/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ backend/
â”‚   â”‚   â”œâ”€â”€ install.sh
â”‚   â”‚   â””â”€â”€ transpile.sh
â”‚   â”œâ”€â”€ frontend/
â”‚   â”‚   â””â”€â”€ build-deploy.sh
â”‚   â”œâ”€â”€ apply-terraform.sh
â”‚   â””â”€â”€ destroy-terraform.sh
----

What is what?

* `backend/lambda/` - contains our Lambda functions
* `infra/terraform/` - contains our Terraform configuration
* `scripts/backend/` - contains the scripts to install and transpile the Lambda functions
* `scripts/frontend/` - contains the script to build and deploy the frontend (exported as static HTML, so it's only uploaded to the S3 bucket)
* `scripts/apply-terraform.sh` - the script to apply the Terraform configuration
* `scripts/destroy-terraform.sh` - the script to destroy the Terraform configuration

So this means, to apply the infrastructure you only need to run the following command:

[source,sh]
----
./scripts/apply-terraform.sh
----

On the first run, you'll be prompted if the AWS account you're currently logged into is correct.
If not, you can abort the process and switch to the correct account.

Let's have a look at the script's output on the first run:

[source,text]
----
$ ./scripts/apply-terraform.sh

No environment specified, defaulting to 'dev'.
Generated project suffix: 609ftfma
variables.tfvars file created with project suffix.
Use AWS account id 590183990318? (y/n): y
AWS account id added to variables.tfvars.
Enter Discord Webhook URL for alerting (leave empty to skip):
Discord Webhook URL skipped. Please remove the line from variables.tfvars if needed later
S3 bucket cw-ho-tf-state-609ftfma created successfully.
backend.tfvars file created with bucket name.
DynamoDB lock table already exists.
Enter email addresses for alerting (comma separated - leave empty to skip):
Email addresses for alerting not provided.
Installing dependencies and transpiling the backend...
Applying Terraform configuration for dev environment...
----

The script will create two files for you:

* `backend.tfvars` - contains the bucket name for the Terraform state, e.g. `bucket = "cw-ho-tf-state-609ftfma"`
* `variables.tfvars` - contains the project suffix and the AWS account ID, e.g. `project_suffix = "609ftfma"` and `aws_account_id = "590183990318"` and the discord webhook URL / alerting emails if provided

It will also create...

* the S3 bucket for the Terraform state
* the DynamoDB lock table for the Terraform state

Afterward, Terraform will already be executed! ðŸŽ‰

== Using the CDK Track